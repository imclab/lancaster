<!DOCTYPE html>

<html>
<head>
  <title>lancaster.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>lancaster.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*
 * https://github.com/simonswain/lancaster
 *
 * Copyright (c) 2013 Simon Swain
 * Licensed under the MIT license.
 */</span>

<span class="string">"use strict"</span>;

<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);

<span class="keyword">var</span> Redis = require(<span class="string">'redis'</span>);

<span class="keyword">var</span> Lancaster = <span class="function"><span class="keyword">function</span><span class="params">(config)</span>{</span>
  
  <span class="keyword">var</span> self = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>boot up a Lancaster server instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> api = {};
  <span class="keyword">var</span> redis;
  <span class="keyword">var</span> rest, sock;

  <span class="keyword">var</span> processing = <span class="literal">false</span>;

  <span class="keyword">var</span> fns = require(<span class="string">'./fns'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="startup">Startup</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Here are a set of routines for booting up the server. They are
run in series when the instance is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> defaults = <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Set some defaults if they were not supplied</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="keyword">if</span>(!config.hasOwnProperty(<span class="string">'redis'</span>)){
      config.redis = {
        host: <span class="string">'127.0.0.1'</span>,
        port: <span class="number">6379</span>,
        prefix: <span class="string">''</span>
      };
    }

    <span class="keyword">if</span>(!config.redis.hasOwnProperty(<span class="string">'prefix'</span>)){
      config.redis.prefix = <span class="string">''</span>;
    }

    next();

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Establish Redis connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> connect = <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>

    redis = Redis.createClient({
      host: config.redis.host,
      port: config.redis.port,
      prefix: config.redis.prefix
    });

    next();

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="methods-for-working-on-the-topology">Methods for working on the topology</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Delete all nodes and other data (eg queues) from the topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> reset = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>

    <span class="keyword">var</span> deleteKeys = <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>redis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      redis.keys(
        config.redis.prefix + <span class="string">'*'</span>,
        <span class="function"><span class="keyword">function</span><span class="params">(err, keys)</span>{</span>
          _.each(keys, <span class="function"><span class="keyword">function</span><span class="params">(key)</span>{</span>
            redis.del(key);
          });
          next();
        });
    };

    async.parallel(
      [deleteKeys], 
      done
    );

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>fetch (id)
all -&gt; (topo)</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>process (id, message) -&gt; message</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>message handler does process then emits event (redis pub) and
distributes message to targets (redis queue)</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Set attrs on a node by persisting them them in Redis as a hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> setAttrs = <span class="function"><span class="keyword">function</span><span class="params">(id, attrs, done)</span>{</span>
    redis.hmset(
      config.redis.prefix + <span class="string">':attrs:'</span> + id,
      attrs,
      done
    );
  };
  
  <span class="keyword">var</span> getAttrs = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>
    redis.hgetall(
      config.redis.prefix + <span class="string">':attrs:'</span> + id,
      <span class="function"><span class="keyword">function</span><span class="params">(err, res)</span>{</span>
        <span class="keyword">if</span>(!res){
          res = {};
        }
        done(<span class="literal">false</span>, res);
      });
  };
  
  <span class="keyword">var</span> delAttrs = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>
    redis.del(
      config.redis.prefix + <span class="string">':attrs:'</span> + id,
      done
    );
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>a node’s sources are persistend as a redis set</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>each node in the sources list has a set of targets. the source
node id is maintained in that set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> addSource = <span class="function"><span class="keyword">function</span><span class="params">(id, source_id, done)</span>{</span>
    async.parallel([
      <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
        redis.sadd(
          config.redis.prefix + <span class="string">':sources:'</span> + id,
          source_id,
          next
        );
      },
      <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
        redis.sadd(
          config.redis.prefix + <span class="string">':targets:'</span> + source_id,
          id,
          next
        );
      }], done);
  };


  <span class="keyword">var</span> delSource = <span class="function"><span class="keyword">function</span><span class="params">(id, source_id, done)</span>{</span>
    redis.srem(
      config.redis.prefix + <span class="string">':sources:'</span> + id,
      source_id
    );
    redis.srem(
      config.redis.prefix + <span class="string">':targets:'</span> + source_id,
      id
    );
    <span class="keyword">return</span> done();
  };


  <span class="keyword">var</span> getSources = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>
    redis.smembers(
      config.redis.prefix + <span class="string">':sources:'</span> + id,
      <span class="function"><span class="keyword">function</span><span class="params">(err, sources)</span>{</span>
        <span class="keyword">if</span>(!sources){
          sources = [];
        }
        <span class="keyword">return</span> done(<span class="literal">false</span>, sources);
      });  
  };

  <span class="keyword">var</span> getTargets = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>
    redis.smembers(
      config.redis.prefix + <span class="string">':targets:'</span> + id,
      <span class="function"><span class="keyword">function</span><span class="params">(err, targets)</span>{</span>
        <span class="keyword">if</span>(!targets){
          targets = [];
        }
        <span class="keyword">return</span> done(<span class="literal">false</span>, targets);
      });  
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>remove all sources from a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> delSources = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span> 
    getSources(
      id, 
      <span class="function"><span class="keyword">function</span><span class="params">(err, sources)</span>{</span>
        <span class="keyword">if</span>(!sources){
          <span class="keyword">return</span> done();
        }
        async.eachSeries(
          sources, 
          <span class="function"><span class="keyword">function</span><span class="params">(source_id, next)</span>{</span>
            delSource(id, source_id, next);
          },
          done
        );
      });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>set/get last message output by node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> setData = <span class="function"><span class="keyword">function</span><span class="params">(id, data, done)</span>{</span>
    redis.set(
      config.redis.prefix + <span class="string">':data:'</span> + id,
      JSON.stringify(data),
      done
    );
  };
  
  <span class="keyword">var</span> getData = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>
    redis.get(
      config.redis.prefix + <span class="string">':data:'</span> + id,
      <span class="function"><span class="keyword">function</span><span class="params">(err, res)</span>{</span>
        <span class="keyword">var</span> data = <span class="literal">null</span>;
        <span class="keyword">if</span>(res){
          data = JSON.parse(res);
        }
        done(<span class="literal">false</span>, data);
      });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>remove any existing sources a node has and replace with provided
set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> setSources = <span class="function"><span class="keyword">function</span><span class="params">(id, sources, done)</span>{</span>
    delSources(id, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span> 
      <span class="keyword">if</span>(!sources){
        <span class="keyword">return</span> done();
      }
      async.eachSeries(
        sources, 
        <span class="function"><span class="keyword">function</span><span class="params">(source_id, next)</span>{</span>
          addSource(id, source_id, next);
        },
        done
      );
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>load node from Redis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> get = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>

    <span class="keyword">var</span> node = {};

    redis.get(
      config.redis.prefix + <span class="string">':nodes:'</span> + id,
      <span class="function"><span class="keyword">function</span><span class="params">(err, res)</span>{</span>

        <span class="keyword">if</span>(err){
          console.log(<span class="string">'ERROR'</span>, err);
          <span class="keyword">return</span> done(err);
        }

        <span class="keyword">if</span>(!res){
          <span class="keyword">return</span> done(<span class="literal">null</span>, <span class="literal">null</span>);
        }

        res = JSON.parse(res);
        node.id = res.id;
        node.fn = res.fn;

        async.parallel([
          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
            getSources(id, <span class="function"><span class="keyword">function</span><span class="params">(err, sources)</span>{</span>
              node.sources = sources;
              next();
            });
          },
          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
            getAttrs(id, <span class="function"><span class="keyword">function</span><span class="params">(err, res)</span>{</span>
              node.attrs = res;
              next();
            });
          },
          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
            getData(id, <span class="function"><span class="keyword">function</span><span class="params">(err, data)</span>{</span>
              node.data = data;
              next();
            });
          }
        ], <span class="function"><span class="keyword">function</span><span class="params">(err)</span>{</span>
          <span class="keyword">if</span>(err){
            console.log(err);
            <span class="keyword">return</span> done(err, <span class="literal">null</span>);
          }
          done(<span class="literal">false</span>, node);
        });
      });

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>get all nodes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> all = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>

    <span class="keyword">var</span> keys = [];
    <span class="keyword">var</span> nodes = {};

    async.series([
      <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
        redis.keys(
          config.redis.prefix + <span class="string">':nodes:*'</span>,
          <span class="function"><span class="keyword">function</span><span class="params">(err, res)</span>{</span>
            <span class="keyword">if</span>(res){
              keys = res;
            }
            next();
          });
      },
      <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
        async.eachSeries(
          keys,
          <span class="function"><span class="keyword">function</span><span class="params">(key, next)</span>{</span>
            <span class="keyword">var</span> id = _.last(key.split(<span class="string">':'</span>)); 
            get(id, <span class="function"><span class="keyword">function</span><span class="params">(err, node)</span>{</span>
              nodes[node.id] = node;
              next();
            });
          }, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
            next();
          });
      }], <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        done(<span class="literal">false</span>, nodes);
      });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>add a node to the topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> add = <span class="function"><span class="keyword">function</span><span class="params">(node, done)</span>{</span>

    get(
      node.id, 
      <span class="function"><span class="keyword">function</span><span class="params">(err, n)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Duplicate node ids generate an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
       <span class="keyword">if</span>(n){
         <span class="keyword">return</span> done(<span class="keyword">new</span> Error(<span class="string">'duplicate-id'</span>));
       }        
       
        <span class="keyword">if</span>(!node.hasOwnProperty(<span class="string">'sources'</span>)){
          node.sources = [];
        }

        <span class="keyword">if</span>(!node.hasOwnProperty(<span class="string">'attrs'</span>)){
          node.attrs = {};
        }

        <span class="keyword">if</span>(!node.hasOwnProperty(<span class="string">'fn'</span>)){
          node.fn = <span class="string">'thru'</span>;
        }
       
        <span class="keyword">var</span> fn = fns[node.fn];

        <span class="keyword">if</span>(fn.hasOwnProperty(<span class="string">'attrs'</span>)){
          _.each(fn.attrs, <span class="function"><span class="keyword">function</span><span class="params">(v, k)</span>{</span>
            <span class="keyword">if</span>(!node.attrs.hasOwnProperty(k)){
              node.attrs[k] = v;
            }
          });
        }

        async.series([

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>save node. id and fn are immutable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> key = config.redis.prefix + <span class="string">':nodes:'</span> + node.id;
            <span class="keyword">var</span> val = {
              id: node.id,
              fn: node.fn
            };
            redis.set(key, JSON.stringify(val));
            next();
          },

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>set the inital sources on the node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            setSources(node.id, node.sources, next);
          },

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>init node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>(!fn.hasOwnProperty(<span class="string">'init'</span>)){
              <span class="keyword">return</span> next();
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>allow init to run. It may set some attrs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            fn.attrs = node.attrs;
            fn.init(next);
          },

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>set the initial attrs on the node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            setAttrs(node.id, node.attrs, next);
          }

        ], <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
          done();
        });
      });  

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>add a node to the topology, providing the correct function for
it’s process handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> del = <span class="function"><span class="keyword">function</span><span class="params">(id, done)</span>{</span>

    get(
      id, 
      <span class="function"><span class="keyword">function</span><span class="params">(err, n)</span>{</span>

        <span class="keyword">if</span>(!n){
          <span class="keyword">return</span> done();
        }

        async.series([

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>id and fn are immutable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> key = config.redis.prefix + <span class="string">':nodes:'</span> + id;
            redis.del(key);
            next();
          },

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
            delSources(id, next);
          },

          <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
            delAttrs(id, next);
          }

        ], done);
      });  

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>queue processing</p>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>do init when first adding node to top, then save attrs that init
might create</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>var processor = new fns[node.fn];
processor.init(function(){
});</p>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>push a message in to a node for processing, get the result (if
any) and push it on to the message queue. emit the message to
listeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">var</span> processMessage = <span class="function"><span class="keyword">function</span><span class="params">(id, data, done)</span>{</span>

    get(
      id, 
      <span class="function"><span class="keyword">function</span><span class="params">(err, node)</span>{</span>

        <span class="keyword">if</span>(!node){
          <span class="keyword">return</span> done(<span class="keyword">new</span> Error(<span class="string">'unknown-node'</span>));
        }
        
        <span class="keyword">var</span> process = fns[node.fn].process;
        process(
          node.attrs,
          data, 
          <span class="function"><span class="keyword">function</span><span class="params">(err, attrs, output)</span>{</span>

            <span class="keyword">if</span>(<span class="keyword">typeof</span> output === <span class="string">'undefined'</span>){           
              setAttrs(id, attrs, done);
            }

            async.parallel([

              <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
                setAttrs(id, attrs, next);
              },

              <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
                setData(id, output, next);
              },

              <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>

                getTargets(id, <span class="function"><span class="keyword">function</span><span class="params">(err, targets)</span>{</span>

                  <span class="keyword">if</span>(targets.length === <span class="number">0</span>){
                    <span class="keyword">return</span> next();
                  }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>if this node has any listeners, distribute the data
to them via the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                  _.each(
                    targets,
                    <span class="function"><span class="keyword">function</span><span class="params">(target_id)</span>{</span>
                      inject(target_id, data);
                    });

                  next();

                });

              },


            ], <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>

              self.emit(<span class="string">'message'</span>, {id: id, data: output});
              done(<span class="literal">false</span>, output);

            });


          });

      });

  };

<span class="keyword">var</span> runTimer = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>run one tick of the topology. Pull a message off the queue and
have it processed by it’s target node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> run = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>

    <span class="keyword">if</span>(!processing){
      <span class="keyword">return</span>;
    }

    redis.rpop(
      config.redis.prefix + <span class="string">':queue'</span>,
      <span class="function"><span class="keyword">function</span><span class="params">(err, reply)</span>{</span>
        <span class="keyword">if</span>(err){
          console.log(<span class="string">'#run error'</span>, err);
          run();
          <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (!reply){</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>timed out, no message</p>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>don’t smash Redis.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          runTimer = setTimeout(run, <span class="number">250</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>process.nextTick(run);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span>;
        }
        <span class="keyword">var</span> id, msg, input;
        <span class="keyword">try</span> {
          input = JSON.parse(reply);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>if brpop
input = JSON.parse(reply[1]);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>bad json</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          console.log(<span class="string">'bad json'</span>, e, reply);
          process.nextTick(run);
          <span class="keyword">return</span>;
        }       
        processMessage(
          input.id,
          input.data,
          <span class="function"><span class="keyword">function</span><span class="params">(err)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>console.log(‘processed, running again’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            process.nextTick(run);
          });
      });
  };


  <span class="keyword">var</span> inject = <span class="function"><span class="keyword">function</span><span class="params">(id, data, done)</span>{</span>
    
    <span class="keyword">var</span> message = {
      at: <span class="keyword">new</span> Date().getTime(),
      id: id,
      data: data
    };

    redis.lpush(
      config.redis.prefix + <span class="string">':queue'</span>,
      JSON.stringify(message),
      <span class="function"><span class="keyword">function</span><span class="params">(err)</span>{</span>
        <span class="keyword">if</span>(done){
          done();
        }
      });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>start accepting (polling for) messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.startProcessing = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>
    processing = <span class="literal">true</span>;
    process.nextTick(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      run();
    });
    <span class="keyword">if</span>(done){
      done();
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>stop processing after the next message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.stopProcessing = <span class="function"><span class="keyword">function</span><span class="params">(cb)</span>{</span>
    self.onStopProcessing = cb;
    <span class="keyword">if</span>(runTimer){
      clearTimeout(runTimer);
    }
    processing = <span class="literal">false</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Get everything running</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> start = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>
    async.series(
      [
        defaults, connect
      ],
      <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        self.emit(<span class="string">'start'</span>);
        process.nextTick(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
          <span class="keyword">if</span>(done) {
            done();
          }
        });
      }
    );
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Take everything down cleanly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> stop = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>

    <span class="keyword">if</span>(processing){
      processing = <span class="literal">false</span>;
    }

    async.series([
      <span class="function"><span class="keyword">function</span><span class="params">(next)</span>{</span>
        redis.quit();
        next();
      }
    ], <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      self.emit(<span class="string">'stop'</span>);
      process.nextTick(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="keyword">if</span>(done) {
          done();
        }
      });
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h1 id="api">API</h1>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>methods we want to expose</p>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>start up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.start = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>
    <span class="keyword">return</span> start(done);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>shut down</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.stop = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>
    <span class="keyword">return</span> stop(done);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Reset the database and topology to pristine state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.reset = <span class="function"><span class="keyword">function</span><span class="params">(done)</span>{</span>
    <span class="keyword">return</span> reset(done);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Get all nodes, sources and attrs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.all = all;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Get a single node. Callback provides null if doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.get = get;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>add a node to the topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.add = add;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>remove a node from the topology</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.del = del;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>set attrs on a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.set = setAttrs;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>// inject a message in to a node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">this</span>.inject = inject;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>api.inject = this.inject = function(id, message, done){
  return topology.inject(id, message, done);
};</p>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>// Get last message processed output by node
api.message = this.message = function(id){
  return topology.message(id);
};</p>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>start/stop processing messages</p>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>this.run = run</p>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>this.halt = halt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="keyword">return</span> <span class="keyword">this</span>;

};</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="keyword">var</span> eventSplitter = <span class="regexp">/\s+/</span>;

Lancaster.prototype.on = <span class="function"><span class="keyword">function</span><span class="params">(events, callback, context)</span> {</span>
  <span class="keyword">var</span> calls, event, list;
  <span class="keyword">if</span> ( ! callback ) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  events = events.split(eventSplitter);
  calls = <span class="keyword">this</span>._callbacks || (<span class="keyword">this</span>._callbacks = {});

  <span class="keyword">while</span> (event = events.shift()) {
    list = calls[event] || (calls[event] = []);
    list.push(callback, context);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};

Lancaster.prototype.off = <span class="function"><span class="keyword">function</span><span class="params">(events, callback, context)</span> {</span>
  <span class="keyword">var</span> event, calls, list, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>No events, or removing <em>all</em> events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> ( ! ( calls = <span class="keyword">this</span>._callbacks ) ) {
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  <span class="keyword">if</span> ( ! ( events || callback || context ) ) {
    <span class="keyword">delete</span> <span class="keyword">this</span>._callbacks;
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  events = events ? events.split(eventSplitter) : _.keys(calls);</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Loop through the callback list, splicing where appropriate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">while</span> (event = events.shift()) {
    <span class="keyword">if</span> (!(list = calls[event]) || !(callback || context)) {
      <span class="keyword">delete</span> calls[event];
      <span class="keyword">continue</span>;
    }

    <span class="keyword">for</span> (i = list.length - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">2</span>) {
      <span class="keyword">if</span> (!(callback &amp;&amp; list[i] !== callback || context &amp;&amp; list[i + <span class="number">1</span>] !== context)) {
        list.splice(i, <span class="number">2</span>);
      }
    }
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;

};

Lancaster.prototype.emit = <span class="function"><span class="keyword">function</span><span class="params">(events)</span> {</span>
  <span class="keyword">var</span> event, calls, list, i, length, args, all, rest;
  <span class="keyword">if</span> (!(calls = <span class="keyword">this</span>._callbacks)){
    <span class="keyword">return</span> <span class="keyword">this</span>;
  }

  rest = [];
  events = events.split(eventSplitter);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Fill up <code>rest</code> with the callback arguments.  Since we’re only copying
the tail of <code>arguments</code>, a loop is much faster than Array#slice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> (i = <span class="number">1</span>, length = arguments.length; i &lt; length; i++) {
    rest[i - <span class="number">1</span>] = arguments[i];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>For each event, walk through the list of callbacks twice, first to
trigger the event, then to trigger any <code>&quot;all&quot;</code> callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">while</span> (event = events.shift()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Copy callback lists to prevent modification.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (all = calls.all) {
      all = all.slice();
    }

    <span class="keyword">if</span> (list = calls[event]) {
      list = list.slice();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Execute event callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (list) {
      <span class="keyword">for</span> (i = <span class="number">0</span>, length = list.length; i &lt; length; i += <span class="number">2</span>) {
        list[i].apply(list[i + <span class="number">1</span>] || <span class="keyword">this</span>, rest);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Execute “all” callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (all) {
      args = [event].concat(rest);
      <span class="keyword">for</span> (i = <span class="number">0</span>, length = all.length; i &lt; length; i += <span class="number">2</span>) {
        all[i].apply(all[i + <span class="number">1</span>] || <span class="keyword">this</span>, args);
      }
    }
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};

module.exports = Lancaster;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
